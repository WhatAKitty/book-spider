{"version":3,"sources":["../../src/api/book.api.js"],"names":["BookApi","prefix","get","ctx","next","recommends","data","err","status","body","msg","query","searchBooks","bookInfo","bookId","params","iosDeviceType","chapters","pageIndex","source","findChapters","map","chapterId","chapter","title","syncContent","content","comments","start","result"],"mappings":"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","file":"book.api.js","sourcesContent":["\nimport Router from 'koa-router';\nimport QidianClient from '../qidian.client';\nimport parserFactory from '../core/parser';\n\nconst BookApi = new Router({\n  prefix: '/books',\n});\n\n/**\n * 推荐书籍\n */\nBookApi.get('/recommend', async (ctx, next) => {\n  const { data, err } = await QidianClient.recommends();\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 图书推荐接口\n */\nBookApi.get('/recommends', async (ctx, next) => {\n  const { data, err } = await QidianClient.recommends(ctx.query);\n  \n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 图书查询接口\n */\nBookApi.get('/', async (ctx, next) => {\n  const { data, err } = await QidianClient.searchBooks(ctx.query);\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 图书详情接口\n */\nBookApi.get('/:bookId', async (ctx, next) => {\n  const { data, err } = await QidianClient.bookInfo({\n    bookId: ctx.params.bookId,\n    iosDeviceType: ctx.query.iosDeviceType,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 图书的章节列表\n */\nBookApi.get('/:bookId/chapters/newest', async (ctx, next) => {\n  // 通过起点获取最新章节\n  const { data, err } = await QidianClient.chapters({\n    bookId: ctx.params.bookId,\n    pageIndex: ctx.query.pageIndex,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 图书的章节列表\n */\nBookApi.get('/:source/:bookId/chapters', async (ctx, next) => {\n  // 通过源站获取章节\n  try {\n    const chapters = await parserFactory(ctx.params.source).findChapters({ bookId: ctx.params.bookId });\n\n    ctx.status = 200;\n    ctx.body = chapters.map(chapter => ({\n      chapterId: chapter.chapterId,\n      title: chapter.title,\n    }));\n  } catch (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n  }\n});\n\n/**\n * 图书的章节内容\n */\nBookApi.get('/:source/:bookId/:chapterId', async (ctx, next) => {\n  try {\n    const chapter = await parserFactory(ctx.params.source).syncContent({ chapterId: ctx.params.chapterId });\n\n    ctx.status = 200;\n    ctx.body = {\n      content: chapter.content,\n    };\n  } catch (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n  }\n});\n\n/**\n * 图书的书评\n */\nBookApi.get('/:bookId/comments', async (ctx, next) => {\n  const { data, err } = await QidianClient.comments({\n    bookId: ctx.params.bookId,\n    pageIndex: ctx.query.pageIndex,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * 开启解析\n */\nBookApi.get('/:source/:bookId/sync', async (ctx, next) => {\n  const result = await parserFactory(ctx.params.source).start({ bookId: ctx.params.bookId });\n\n  if (!result) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: `同步书本${ctx.params.bookId}失败`,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = {\n    msg: `同步书本${ctx.params.bookId}成功`,\n  };\n});\n\nexport default BookApi;\n\n\n"]}