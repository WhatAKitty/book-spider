{"version":3,"sources":["../../src/api/book.api.js"],"names":["BookApi","prefix","get","ctx","next","recommends","query","data","err","status","body","msg","searchBooks","bookInfo","bookId","params","iosDeviceType","chapters","pageIndex","source","findChapters","map","chapterId","chapter","title","syncContent","comments"],"mappings":"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","file":"book.api.js","sourcesContent":["\nimport Router from 'koa-router';\nimport QidianClient from '../qidian.client';\nimport parserFactory from '../core/parser';\n\nconst BookApi = new Router({\n  prefix: '/books',\n});\n\n/**\n * @swagger\n * definitions:\n *   BAD404:\n *     type: object\n *     properties:\n *       msg:\n *         type: object\n *   Book:\n *     type: object\n *     properties:\n *       BookId:\n *         type: number\n *       BookName:\n *         type: string\n *       AuthorId:\n *         type: number\n *       AuthorName:\n *         type: string\n *       Author:\n *         type: string\n *       CategoryId:\n *         type: number\n *       CategoryName:\n *         type: string\n *       ImageStatus:\n *         type: number\n *       LastUpdateChapterID:\n *         type: number\n *       LastUpdateChapterName:\n *         type: string\n *       LastChapterUpdateTime:\n *         type: number\n *       LastVipUpdateChapterId:\n *         type: number\n *       LastVipUpdateChapterName:\n *         type: string\n *       LastVipChapterUpdateTime:\n *         type: number\n *       IsVip:\n *         type: number\n *       BookStatus:\n *         type: number\n *       WordsCount:\n *         type: number\n *       Label:\n *         type: string\n *       IsQin:\n *         type: number\n *       BssReadTotal:\n *         type: number\n *       BssRecomTotal:\n *         type: number\n *       Price:\n *         type: number\n *       NewPrice:\n *         type: number\n *       Recommendation:\n *         type: string\n *       RecommenId:\n *         type: number\n *       GroupName:\n *         type: string\n *       ReadingType:\n *         type: number\n *       AlgInfo:\n *         type: string\n *       PartCount:\n *         type: number\n *       SourceBookId:\n *         type: number\n *       BookPartInfo:\n *         type: string\n *       ChargeType:\n *         type: number\n *       TotalPrice:\n *         type: number\n *       Description:\n *         type: string\n *   GroupItem:\n *     type: object\n *     properties:\n *       Title:\n *         type: string\n *       Subtitle:\n *         type: string\n *       ActionUrl:\n *         type: string\n *       Direction:\n *         type: string\n *       UpdateDesc:\n *         type: string\n *       Data:\n *         type: array\n *         items:\n *           $ref: '#/definitions/Book'\n *   Cover:\n *     type: object\n *     properties:\n *       Pic:\n *         type: string\n *       ActionUrl:\n *         type: string\n *   Recommends:\n *     type: object\n *     properties:\n *       CoverList:\n *         type: array\n *         items:\n *           $ref: '#/definitions/Cover'\n *       Group:\n *         type: array\n *         items:\n *           $ref: '#/definitions/GroupItem'\n *   Chapter:\n *     type: object\n *     properties:\n *       c:\n *         type: number\n *       n:\n *         type: string\n *       ov:\n *         type: number\n *       p:\n *         type: number\n *       t:\n *         type: number\n *       w:\n *         type: number\n *       vc:\n *         type: string\n *       ui:\n *         type: number\n *       ccs:\n *         type: number\n *       cci:\n *         type: number\n *   ChapterResp:\n *     type: object\n *     properties:\n *       BookId:\n *         type: number\n *       BookName:\n *         type: string\n *       AuthorId:\n *         type: number\n *       AuthorName:\n *         type: string\n *       Author:\n *         type: string\n *       CategoryId:\n *         type: number\n *       CategoryName:\n *         type: string\n *       ImageStatus:\n *         type: number\n *       LastUpdateChapterID:\n *         type: number\n *       LastUpdateChapterName:\n *         type: string\n *       LastChapterUpdateTime:\n *         type: number\n *       LastVipUpdateChapterId:\n *         type: number\n *       LastVipUpdateChapterName:\n *         type: string\n *       LastVipChapterUpdateTime:\n *         type: number\n *       IsVip:\n *         type: number\n *       BookStatus:\n *         type: number\n *       WordsCount:\n *         type: number\n *       Label:\n *         type: string\n *       IsQin:\n *         type: number\n *       Chapters:\n *         type: array\n *         items:\n *           $ref: '#/definitions/Chapter'\n *       IsReload:\n *         type: number\n *       DeletedChapters:\n *         type: string\n *       Volumes:\n *         type: array\n *         items:\n *           type: object\n *           properties:\n *             VolumeCode:\n *               type: string\n *             VolumeName:\n *               type: string\n *       EnableBookUnitLease:\n *         type: number\n *       EnableBookUnitBuy:\n *         type: number\n *       Units:\n *         type: string\n *       WholeSale:\n *         type: number\n *       TotalPrice:\n *         type: number\n *   Comment:\n *     type: object\n *     properties:\n *       RankName:\n *         type: string \n *       Id:\n *         type: number\n *       ViewCount:\n *         type: number\n *       PostCount:\n *         type: number\n *       Subject:\n *         type: string\n *       UserName:\n *         type: string\n *       UserId:\n *         type: number\n *       PostDate:\n *         type: long\n *       Body:\n *         type: string\n *       Type:\n *         type: number\n *       VoteYes:\n *         type: number\n *       VoteAgainst:\n *         type: number\n *       UserHeadIcon:\n *         type: string\n *       From:\n *         type: string\n */\n\n/**\n * @swagger\n * /api/v1/books/recommends:\n *   get:\n *     description: 推荐书籍\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取书籍推荐\n *         schema:\n *           $ref: '#/definitions/Recommends'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n *         \n */\nBookApi.get('/recommends', async (ctx, next) => {\n  const { data, err } = await QidianClient.recommends(ctx.query);\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v1/books:\n *   get:\n *     description: 图书查询\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: key\n *         description: 关键字\n *         in: query\n *         required: false\n *         type: string\n *       - name: channel\n *         description: 图书来源渠道\n *         in: query\n *         required: false\n *         type: integer\n *       - name: firstEntry\n *         description: 图书来源渠道\n *         in: query\n *         required: false\n *         type: integer\n *       - name: order\n *         description: 查询排序\n *         in: query\n *         required: false\n *         type: integer\n *       - name: pageIndex\n *         description: 查询开始页索引\n *         in: query\n *         required: false\n *         type: integer\n *       - name: size\n *         description: 图书字数\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功搜索到书籍\n *         schema:\n *           type: array\n *           items:\n *             $ref: '#/definitions/Book'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n *         \n */\nBookApi.get('/', async (ctx, next) => {\n  const { data, err } = await QidianClient.searchBooks(ctx.query);\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data || [];\n});\n\n/**\n * @swagger\n * /api/v1/books/{bookId}:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 图书详情接口\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: iosDeviceType\n *         description: 是否IOS设备\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功获取书籍详情\n *         schema:\n *           $ref: '#/definitions/Book'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'      \n */\nBookApi.get('/:bookId', async (ctx, next) => {\n  const { data, err } = await QidianClient.bookInfo({\n    bookId: ctx.params.bookId,\n    iosDeviceType: ctx.query.iosDeviceType,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v1/books/{bookId}/chapters/newest:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 最新图书章节列表\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: iosDeviceType\n *         description: 是否IOS设备\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功获取书籍详情\n *         schema:\n *           $ref: '#/definitions/ChapterResp'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:bookId/chapters/newest', async (ctx, next) => {\n  // 通过起点获取最新章节\n  const { data, err } = await QidianClient.chapters({\n    bookId: ctx.params.bookId,\n    pageIndex: ctx.query.pageIndex,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v1/books/{source}/{bookId}/chapters:\n *   parameters:\n *     - name: source\n *       description: 源站编号\n *       in: path\n *       required: true\n *       type: string\n *       enum:\n *         - qbg\n *         - ybdu\n *       x-example: qbg\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 源站图书章节列表\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取图书章节列表\n *         schema:\n *           type: array\n *           items:\n *             type: object\n *             properties:\n *               chapterId:\n *                 type: string\n *               title:\n *                 type: stirng\n *       400:\n *         description: 无法获取图书章节列表\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:source/:bookId/chapters', async (ctx, next) => {\n  // 通过源站获取章节\n  try {\n    const chapters = await parserFactory(ctx.params.source).findChapters({ bookId: ctx.params.bookId });\n\n    ctx.status = 200;\n    ctx.body = chapters.map(chapter => ({\n      chapterId: chapter.chapterId,\n      title: chapter.title,\n    }));\n  } catch (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n  }\n});\n\n/**\n * @swagger\n * /api/v1/books/{source}/{bookId}/{chapterId}:\n *   parameters:\n *     - name: source\n *       description: 源站编号\n *       in: path\n *       required: true\n *       type: string\n *       enum:\n *         - qbg\n *         - ybdu\n *       x-example: qbg\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *     - name: chapterId\n *       description: 章节编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 112\n *   get:\n *     description: 源站章节内容\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取图书章节内容\n *         schema:\n *           type: object\n *           properties:\n *             content:\n *               type: string\n *             title:\n *               type: string\n *       400:\n *         description: 无法获取图书章节内容\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:source/:bookId/:chapterId', async (ctx, next) => {\n  try {\n    const chapter = await parserFactory(ctx.params.source).syncContent({ bookId: ctx.params.bookId, chapterId: ctx.params.chapterId });\n\n    ctx.status = 200;\n    ctx.body = {\n      ...chapter,\n    };\n  } catch (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n  }\n});\n\n/**\n * @swagger\n * /api/v1/books/{bookId}/comments:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 图书书评列表\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: pageIndex\n *         description: 开始索引\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功获取图书书评\n *         schema:\n *           type: array\n *           items:\n *             $ref: '#/definitions/Comment'\n *       400:\n *         description: 无法获取图书书评\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:bookId/comments', async (ctx, next) => {\n  const { data, err } = await QidianClient.comments({\n    bookId: ctx.params.bookId,\n    pageIndex: ctx.query.pageIndex,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n// /**\n//  * 开启解析\n//  */\n// BookApi.get('/:source/:bookId/sync', async (ctx, next) => {\n//   const result = await parserFactory(ctx.params.source).start({ bookId: ctx.params.bookId });\n\n//   if (!result) {\n//     ctx.status = 400;\n//     ctx.body = {\n//       msg: `同步书本${ctx.params.bookId}失败`,\n//     };\n//     return;\n//   }\n\n//   ctx.status = 200;\n//   ctx.body = {\n//     msg: `同步书本${ctx.params.bookId}成功`,\n//   };\n// });\n\nexport default BookApi;\n\n\n"]}