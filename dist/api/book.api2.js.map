{"version":3,"sources":["../../src/api/book.api2.js"],"names":["BookApi","prefix","get","ctx","next","recommends","data","err","status","body","msg","Promise","all","Group","map","raw","Title","Subtitle","Data","rawBook","searchBooks","key","BookName","zhuishuBooks","zhuishuErr","console","error","log","title","_id","author","Author","cover","BookId","majorCate","CategoryName","minorCate","undefined","shortIntro","Description","lastChapter","LastVipUpdateChapterName","LastUpdateChapterName","subTitle","books","result","query","bookInfo","bookId","params","newestChapter","bookIds","chapters","chaptersBySource","sourceId","link","parsed","Buffer","replace","toString","content","encodeURIComponent","comments","pageIndex"],"mappings":"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","file":"book.api2.js","sourcesContent":["\nimport Router from 'koa-router';\nimport ZhuishuClient from '../zhuishu.client';\nimport QidianClient from '../qidian.client';\nimport parserFactory from '../core/parser';\n\nconst BookApi = new Router({\n  prefix: '/api/v2/books',\n});\n\n/**\n * @swagger\n * definitions:\n *   BAD404:\n *     type: object\n *     properties:\n *       msg:\n *         type: object\n *   Book:\n *     type: object\n *     properties:\n *       _id:\n *         type: string\n *       title:\n *         type: string\n *       author:\n *         type: string\n *       longIntro:\n *         type: string\n *       conver:\n *         type: string\n *       creater:\n *         type: number\n *       majorCate:\n *         type: string\n *       minorCate:\n *         type: string\n *       rating:\n *         type: object\n *         properties:\n *           count:\n *             type: number,\n *           score:\n *             type: number,\n *           isEffect:\n *             type: boolean,\n *       hasCopyright:\n *         type: boolean\n *       updated:\n *         type: string\n *       chaptersCount:\n *         type: number\n *       lastChapter:\n *         type: string\n *       gender:\n *         type: array\n *       tags:\n *         type: array\n *       cat:\n *         type: string\n *   Recommends:\n *     type: array\n *     items:\n *       $ref: '#/definitions/Book'\n *   Chapter:\n *     type: object\n *     properties:\n *       c:\n *         type: number\n *       n:\n *         type: string\n *       ov:\n *         type: number\n *       p:\n *         type: number\n *       t:\n *         type: number\n *       w:\n *         type: number\n *       vc:\n *         type: string\n *       ui:\n *         type: number\n *       ccs:\n *         type: number\n *       cci:\n *         type: number\n *   ChapterResp:\n *     type: object\n *     properties:\n *       BookId:\n *         type: number\n *       BookName:\n *         type: string\n *       AuthorId:\n *         type: number\n *       AuthorName:\n *         type: string\n *       Author:\n *         type: string\n *       CategoryId:\n *         type: number\n *       CategoryName:\n *         type: string\n *       ImageStatus:\n *         type: number\n *       LastUpdateChapterID:\n *         type: number\n *       LastUpdateChapterName:\n *         type: string\n *       LastChapterUpdateTime:\n *         type: number\n *       LastVipUpdateChapterId:\n *         type: number\n *       LastVipUpdateChapterName:\n *         type: string\n *       LastVipChapterUpdateTime:\n *         type: number\n *       IsVip:\n *         type: number\n *       BookStatus:\n *         type: number\n *       WordsCount:\n *         type: number\n *       Label:\n *         type: string\n *       IsQin:\n *         type: number\n *       Chapters:\n *         type: array\n *         items:\n *           $ref: '#/definitions/Chapter'\n *       IsReload:\n *         type: number\n *       DeletedChapters:\n *         type: string\n *       Volumes:\n *         type: array\n *         items:\n *           type: object\n *           properties:\n *             VolumeCode:\n *               type: string\n *             VolumeName:\n *               type: string\n *       EnableBookUnitLease:\n *         type: number\n *       EnableBookUnitBuy:\n *         type: number\n *       Units:\n *         type: string\n *       WholeSale:\n *         type: number\n *       TotalPrice:\n *         type: number\n *   Comment:\n *     type: object\n *     properties:\n *       RankName:\n *         type: string \n *       Id:\n *         type: number\n *       ViewCount:\n *         type: number\n *       PostCount:\n *         type: number\n *       Subject:\n *         type: string\n *       UserName:\n *         type: string\n *       UserId:\n *         type: number\n *       PostDate:\n *         type: long\n *       Body:\n *         type: string\n *       Type:\n *         type: number\n *       VoteYes:\n *         type: number\n *       VoteAgainst:\n *         type: number\n *       UserHeadIcon:\n *         type: string\n *       From:\n *         type: string\n */\n\n/**\n * @swagger\n * /api/v2/books/recommends:\n *   get:\n *     description: 推荐书籍\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: gender\n *         description: 分类（'male', 'female', 'press'）\n *         in: query\n *         required: true\n *         type: string\n *       - name: start\n *         description: 开始索引\n *         in: query\n *         required: false\n *         type: integer\n *       - name: limit\n *         description: 总查询条数\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功获取书籍推荐\n *         schema:\n *           $ref: '#/definitions/Recommends'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n *         \n */\nBookApi.get('/recommends', async (ctx, next) => {\n  const {data, err} = await QidianClient.recommends();\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  // wrap groups\n  const result = await Promise.all(data.Group.map(async raw => {\n    return {\n      title: raw.Title,\n      subTitle: raw.Subtitle,\n      books: await Promise.all(raw.Data.map(async rawBook => {\n        const { data: zhuishuBooks, err: zhuishuErr} = await ZhuishuClient.searchBooks({\n          key: rawBook.BookName,\n        });\n        if (err) {\n          console.error(`搜索图书 ${rawBook.BookName} 失败`, err);\n          return true;\n        }\n\n        console.log(`搜索到图书 ${zhuishuBooks[0].title}`)\n        return {\n          _id: `${zhuishuBooks[0]._id}`,\n          title: rawBook.BookName,\n          author: rawBook.Author,\n          cover: `https://qidian.qpic.cn/qdbimg/349573/${rawBook.BookId}/180`,\n          majorCate: rawBook.CategoryName,\n          minorCate: undefined,\n          shortIntro: rawBook.Description,\n          lastChapter: rawBook.LastVipUpdateChapterName || rawBook.LastUpdateChapterName,\n        };\n      })),\n    };\n  }));\n\n  ctx.status = 200;\n  ctx.body = result;\n});\n\n/**\n * @swagger\n * /api/v2/books:\n *   get:\n *     description: 图书查询\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: key\n *         description: 关键字\n *         in: query\n *         required: false\n *         type: string\n *     responses:\n *       200:\n *         description: 成功搜索到书籍\n *         schema:\n *           type: array\n *           items:\n *             $ref: '#/definitions/Book'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n *         \n */\nBookApi.get('/', async (ctx, next) => {\n  const { data, err } = await ZhuishuClient.searchBooks(ctx.query);\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data || [];\n});\n\n/**\n * @swagger\n * /api/v2/books/{bookId}:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 图书详情接口\n *     produces:\n *       - application/json\n *     responses:\n *       200:\n *         description: 成功获取书籍详情\n *         schema:\n *           $ref: '#/definitions/Book'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'      \n */\nBookApi.get('/:bookId', async (ctx, next) => {\n  const { data, err } = await ZhuishuClient.bookInfo({\n    bookId: ctx.params.bookId,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v2/books/{bookId}/chapters/newest:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 最新图书章节列表\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取书籍详情\n *         schema:\n *           $ref: '#/definitions/ChapterResp'\n *       400:\n *         description: 无法获取书籍推荐数据\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:bookId/chapters/newest', async (ctx, next) => {\n  // 通过起点获取最新章节\n  const { data, err } = await ZhuishuClient.newestChapter({\n    bookIds: [ctx.params.bookId],\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data[ctx.params.bookId];\n});\n\n/**\n * @swagger\n * /api/v2/books/{bookId}/chapters:\n *   parameters:\n *     - name: source\n *       description: 源站编号\n *       in: path\n *       required: true\n *       type: string\n *       enum:\n *         - qbg\n *         - ybdu\n *       x-example: qbg\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 源站图书章节列表\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取图书章节列表\n *         schema:\n *           type: array\n *           items:\n *             type: object\n *             properties:\n *               chapterId:\n *                 type: string\n *               title:\n *                 type: stirng\n *       400:\n *         description: 无法获取图书章节列表\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:bookId/chapters', async (ctx, next) => {\n  const { data, err } = await ZhuishuClient.chapters({\n    bookId: ctx.params.bookId,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v2/books/{sourceId}/chapters:\n *   get:\n *     description: 某个小说源的章节内容\n *     produces:\n *       - application/json\n */\nBookApi.get('/:sourceId/chapters', async (ctx, next) => {\n  const { data, err } = await ZhuishuClient.chaptersBySource({\n    sourceId: ctx.params.sourceId,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v2/books/chapter/{link}:\n *   parameters:\n *     - name: source\n *       description: 源站编号\n *       in: path\n *       required: true\n *       type: string\n *       enum:\n *         - qbg\n *         - ybdu\n *       x-example: qbg\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *     - name: chapterId\n *       description: 章节编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 112\n *   get:\n *     description: 源站章节内容\n *     produces:\n *       - application/json\n *     parameters:\n *     responses:\n *       200:\n *         description: 成功获取图书章节内容\n *         schema:\n *           type: object\n *           properties:\n *             content:\n *               type: string\n *             title:\n *               type: string\n *       400:\n *         description: 无法获取图书章节内容\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/chapter/:link', async (ctx, next) => {\n  const raw = ctx.params.link;\n  const parsed = new Buffer(raw.replace('xiegang', '/'), 'base64').toString();\n  const { data, err } = await ZhuishuClient.content({\n    link: encodeURIComponent(parsed),\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\n/**\n * @swagger\n * /api/v2/books/{bookId}/comments:\n *   parameters:\n *     - name: bookId\n *       description: 书本编号\n *       in: path\n *       required: true\n *       type: integer\n *       x-example: 42\n *   get:\n *     description: 图书书评列表\n *     produces:\n *       - application/json\n *     parameters:\n *       - name: pageIndex\n *         description: 开始索引\n *         in: query\n *         required: false\n *         type: integer\n *     responses:\n *       200:\n *         description: 成功获取图书书评\n *         schema:\n *           type: array\n *           items:\n *             $ref: '#/definitions/Comment'\n *       400:\n *         description: 无法获取图书书评\n *         schema:\n *           $ref: '#/definitions/BAD404'\n */\nBookApi.get('/:bookId/comments', async (ctx, next) => {\n  const { data, err } = await ZhuishuClient.comments({\n    bookId: ctx.params.bookId,\n    pageIndex: ctx.query.pageIndex,\n  });\n\n  if (err) {\n    ctx.status = 400;\n    ctx.body = {\n      msg: err,\n    };\n    return;\n  }\n\n  ctx.status = 200;\n  ctx.body = data;\n});\n\nexport default BookApi;\n\n"]}